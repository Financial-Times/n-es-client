# CONFIG GENERATED BY DOTCOM-TOOL-KIT, DO NOT EDIT BY HAND
version: 2.1
orbs:
  tool-kit: financial-times/dotcom-tool-kit@3
  node: circleci/node@5.0.2
jobs:
  checkout:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - tool-kit/persist-workspace:
          path: .
  testci-coverage:
    executor:
      name: node/default
      tag: <<parameters.node-version>>
    parameters:
      node-version:
        default: "16.14"
        type: string
    steps:
      - tool-kit/attach-workspace
      - run:
          name: Run tests coverage
          command: "npm run coverage"
          environment:
            JEST_JUNIT_OUTPUT: test-results/jest/results.xml # TODO change depending on which test plugin is running? or actually, move this into the plugin? or do it as tool kit config. hmm
            MOCHA_FILE: test-results/mocha/results.xml
      - run:
          name: output coverage report
          command: "cat ./coverage/lcov.info | ./node_modules/.bin/coveralls"
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: test-results
workflows:
  version: 2
  tool-kit:
    when:
      not:
        equal:
          - scheduled_pipeline
          - << pipeline.trigger_source >>
    jobs:
      - checkout:
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - waiting-for-approval:
          type: approval
          filters:
            branches:
              only: /(^renovate-.*|^nori/.*)/
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/setup:
          requires:
            - checkout
            - waiting-for-approval
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/build:
          node-version: 16.14-browsers
          requires:
            - tool-kit/setup
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/test:
          node-version: 16.14-browsers
          requires:
            - tool-kit/build
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - testci-coverage:
          node-version: 16.14-browsers
          requires:
            - tool-kit/build
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/publish:
          node-version: 16.14-browsers
          context: npm-publish-token
          requires:
            - tool-kit/test
            - testci-coverage
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
  nightly:
    when:
      and:
        - equal:
            - scheduled_pipeline
            - << pipeline.trigger_source >>
        - equal:
            - nightly
            - << pipeline.schedule.name >>
    jobs:
      - checkout
      - tool-kit/setup:
          requires:
            - checkout
      - tool-kit/build:
          requires:
            - tool-kit/setup
      - tool-kit/test:
          requires:
            - tool-kit/build
